---
- name: Force Wipe - Fix Cisco Installer Wizard & Folder Locks
  hosts: windows
  gather_facts: no

  tasks:
    - name: 1. Kill Posture Services and Processes
      ansible.windows.win_shell: |
        # Stop specific processes to unlock ciscod.exe
        $apps = "ciscod", "csc_ui", "aciscoposture", "vpnagent"
        foreach ($app in $apps) {
            Get-Process -Name $app -ErrorAction SilentlyContinue | Stop-Process -Force
        }
        # Disable and Stop services so they don't restart during deletion
        $services = "ciscod", "aciscoposture", "vpnagent", "csc_*"
        foreach ($s in $services) {
            Set-Service -Name $s -StartupType Disabled -ErrorAction SilentlyContinue
            Stop-Service -Name $s -Force -ErrorAction SilentlyContinue
        }

    - name: 2. Scrub Registry (This removes the "Repair/Modify" Wizard)
      ansible.windows.win_shell: |
        $regPaths = @(
            "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall",
            "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall",
            "HKLM:\SOFTWARE\Cisco"
        )
        foreach ($path in $regPaths) {
            if (Test-Path $path) {
                Get-ChildItem $path -ErrorAction SilentlyContinue | Get-ItemProperty | Where-Object { 
                    $_.DisplayName -like "*Cisco*" -or $_.Publisher -like "*Cisco*" 
                } | ForEach-Object {
                    Remove-Item -Path $_.PSPath -Recurse -Force -ErrorAction SilentlyContinue
                }
            }
        }

    - name: 3. Force Remove Folders via PowerShell
      ansible.windows.win_shell: |
        $folders = "C:\Program Files (x86)\Cisco", "C:\ProgramData\Cisco"
        foreach ($f in $folders) {
            if (Test-Path $f) {
                Remove-Item -Path $f -Recurse -Force -ErrorAction SilentlyContinue
            }
        }

    - name: 4. Send 1-Minute Warning
      ansible.windows.win_shell: |
        msg.exe * /TIME:30 "Cisco traces removed. Rebooting in 60 seconds to clear drivers."

    - name: 5. Final Reboot (Mandatory to clear locks)
      ansible.windows.win_reboot:
        msg: "Full Cisco Wipe complete. System is now clean for a fresh install."