---
- name: Force Wipe - Cisco Posture and Ghost Files with Warning
  hosts: windows
  gather_facts: no

  tasks:
    - name: 1. Kill Posture and Core Services
      ansible.windows.win_shell: |
        $apps = "ciscod", "csc_ui", "CiscoCollabHost", "aciscoposture", "vpnagent"
        foreach ($app in $apps) {
            Get-Process -Name $app -ErrorAction SilentlyContinue | Stop-Process -Force
        }
        $services = "ciscod", "aciscoposture", "vpnagent", "csc_*"
        foreach ($s in $services) {
            Stop-Service -Name $s -Force -ErrorAction SilentlyContinue
        }

    - name: 2. Deep Clean Uninstall via MSI
      ansible.windows.win_shell: |
        $apps = Get-Package -Name "*Cisco Secure Client*", "*AnyConnect*" -ErrorAction SilentlyContinue
        foreach ($app in $apps) {
            msiexec.exe /x $app.FastPackageID /qn /norestart
        }

    - name: 3. Scrub Registry and Remove Directories
      ansible.windows.win_shell: |
        # Registry Scrub
        $regPaths = @("HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall", "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall")
        foreach ($path in $regPaths) {
            Get-ChildItem $path -ErrorAction SilentlyContinue | Get-ItemProperty | Where-Object { $_.DisplayName -like "*Cisco*" } | Remove-Item -Path $_.PSPath -Recurse -Force -ErrorAction SilentlyContinue
        }
        # Folder Wipe
        $folders = "C:\Program Files (x86)\Cisco", "C:\ProgramData\Cisco"
        foreach ($f in $folders) { if (Test-Path $f) { Remove-Item -Path $f -Recurse -Force -ErrorAction SilentlyContinue } }

    - name: 4. Send 5-Minute Warning to User (Native PowerShell)
      ansible.windows.win_shell: |
        $msg = "Cisco Migration: Your computer will restart in 5 minutes to complete the cleanup. Please save your work."
        $wshell = New-Object -ComObject WScript.Shell
        $wshell.Popup($msg, 10, "System Maintenance", 64)
      # 10 is the timeout for the popup itself; 64 is the Information Icon

    - name: 5. Wait for 5 Minutes
      ansible.builtin.pause:
        minutes: 5

    - name: 6. Final Reboot
      ansible.windows.win_reboot:
        msg: "Cisco Wipe complete. Rebooting now."